### Report Summary

File:| fs/isofs/inode.c
---|---
Warning:| line 1293, column 2
Pointer freed in cleanup then retried without resetting to NULL; early goto
can double free

### Annotated Source Code


1243  | 		de = (struct iso_directory_record *) (bh->b_data + offset);
1244  | 		de_len = *(unsigned char *) de;
1245  |
1246  |  if (de_len == 0) {
1247  | 			brelse(bh);
1248  | 			bh = NULL;
1249  | 			++block;
1250  | 			offset = 0;
1251  |  continue;
1252  | 		}
1253  |
1254  | 		block_saved = block;
1255  | 		offset_saved = offset;
1256  | 		offset += de_len;
1257  |
1258  |  /* Make sure we have a full directory entry */
1259  |  if (offset >= bufsize) {
1260  |  int slop = bufsize - offset + de_len;
1261  |  if (!tmpde) {
1262  | 				tmpde = kmalloc(256, GFP_KERNEL);
1263  |  if (!tmpde)
1264  |  goto out_nomem;
1265  | 			}
1266  |  memcpy(tmpde, de, slop);
1267  | 			offset &= bufsize - 1;
1268  | 			block++;
1269  | 			brelse(bh);
1270  | 			bh = NULL;
1271  |  if (offset) {
1272  | 				bh = sb_bread(inode->i_sb, block);
1273  |  if (!bh)
1274  |  goto out_noread;
1275  |  memcpy((void *)tmpde+slop, bh->b_data, offset);
1276  | 			}
1277  | 			de = tmpde;
1278  | 		}
1279  |
1280  | 		inode->i_size += isonum_733(de->size);
1281  |  if (i == 1) {
1282  | 			ei->i_next_section_block = block_saved;
1283  | 			ei->i_next_section_offset = offset_saved;
1284  | 		}
1285  |
1286  | 		more_entries = de->flags[-high_sierra] & 0x80;
1287  |
1288  | 		i++;
1289  |  if (i > 100)
1290  |  goto out_toomany;
1291  | 	} while (more_entries);
1292  | out:
1293  |  kfree(tmpde);
    Pointer freed in cleanup then retried without resetting to NULL; early goto can double free
1294  | 	brelse(bh);
1295  |  return 0;
1296  |
1297  | out_nomem:
1298  | 	brelse(bh);
1299  |  return -ENOMEM;
1300  |
1301  | out_noread:
1302  |  printk(KERN_INFO "ISOFS: unable to read i-node block %lu\n", block);
1303  | 	kfree(tmpde);
1304  |  return -EIO;
1305  |
1306  | out_toomany:
1307  |  printk(KERN_INFO "%s: More than 100 file sections ?!?, aborting...\n"
1308  |  "isofs_read_level3_size: inode=%lu\n",
1309  |  __func__, inode->i_ino);
1310  |  goto out;
1311  | }
1312  |
1313  | static int isofs_read_inode(struct inode *inode, int relocated)
1314  | {
1315  |  struct super_block *sb = inode->i_sb;
1316  |  struct isofs_sb_info *sbi = ISOFS_SB(sb);
1317  |  unsigned long bufsize = ISOFS_BUFFER_SIZE(inode);
1318  |  unsigned long block;
1319  |  int high_sierra = sbi->s_high_sierra;
1320  |  struct buffer_head *bh;
1321  |  struct iso_directory_record *de;
1322  |  struct iso_directory_record *tmpde = NULL;
1323  |  unsigned int de_len;
